name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'reset_deploy.sh'

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VULTR_HOST: 80.240.29.142
      VULTR_USER: root
      REMOTE_DIR: /root/VerzekBackend

    steps:
      - name: üîê Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Display deployment info
        run: |
          echo "üöÄ Deploying VerzekAutoTrader Backend to Vultr"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"

      - name: üîß Prepare SSH directory
        run: |
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

      - name: üîë Restore SSH private key
        env:
          VULTR_SSH_KEY_B64: ${{ secrets.VULTR_SSH_KEY_B64 }}
        run: |
          set -euo pipefail

          if [ -z "${VULTR_SSH_KEY_B64:-}" ]; then
            echo "‚ùå ERROR: No SSH private key provided. Set secret VULTR_SSH_KEY_B64."
            exit 1
          fi

          # Debug: Show secret length (not content)
          echo "üîç Secret length: $(echo -n "$VULTR_SSH_KEY_B64" | wc -c) characters"

          SSH_KEY_PATH="$HOME/.ssh/id_ed25519"
          
          # Normalize line endings (CRLF ‚Üí LF) and write key
          printf '%s\n' "$VULTR_SSH_KEY_B64" | base64 -d > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"

          # Verify key validity and show fingerprint
          if ! FINGERPRINT=$(ssh-keygen -lf "$SSH_KEY_PATH" 2>&1); then
            echo "‚ùå ERROR: SSH key is invalid"
            echo "Error: $FINGERPRINT"
            exit 1
          fi
          
          echo "‚úÖ SSH key loaded successfully (ED25519)"
          echo "üîë Key fingerprint (SHA256): ${FINGERPRINT}"

      - name: üóùÔ∏è Add host to known_hosts
        run: |
          ssh-keyscan -H "${{ env.VULTR_HOST }}" > "$HOME/.ssh/known_hosts"
          chmod 644 "$HOME/.ssh/known_hosts"

      - name: üß™ Test SSH connection
        run: |
          set -o pipefail
          ssh -i "$HOME/.ssh/id_ed25519" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            -o ConnectTimeout=10 \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "echo '‚úÖ SSH OK'" \
          || (
            echo "‚ùå SSH FAILED ‚Äî running verbose diagnostics..."
            ssh -vvv -i "$HOME/.ssh/id_ed25519" \
              "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" || true
            exit 1
          )

      - name: üöÄ Execute deployment on server
        run: |
          ssh -i "$HOME/.ssh/id_ed25519" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" << 'ENDSSH'
          set -euo pipefail

          # Clone repo if missing
          if [ ! -d "/root/VerzekBackend" ]; then
            echo "üì¶ Repo directory missing ‚Äî cloning fresh using SSH"
            git clone git@github.com:ellizza78/VerzekBackend.git /root/VerzekBackend
          fi

          cd /root/VerzekBackend

          # Ensure remote uses SSH (not HTTPS)
          echo "üîß Setting Git remote to SSH..."
          git remote set-url origin git@github.com:ellizza78/VerzekBackend.git

          echo "üì• Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          # Run reset script if available
          if [ -x /root/reset_deploy.sh ]; then
            echo "üöÄ Running deployment script..."
            bash /root/reset_deploy.sh
          elif [ -x ./reset_deploy.sh ]; then
            echo "üöÄ Running deployment script..."
            bash ./reset_deploy.sh
          else
            echo "‚ö†Ô∏è  reset_deploy.sh not found ‚Äî skipping"
          fi
          
          echo "‚úÖ Deployment commands completed"
          ENDSSH

      - name: üîç Verify service status
        run: |
          STATUS=$(ssh -i "$HOME/.ssh/id_ed25519" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" \
            "systemctl is-active verzek-api.service || true")

          if [ "$STATUS" != "active" ]; then
            echo "‚ùå Service is DOWN ($STATUS)"
            ssh -i "$HOME/.ssh/id_ed25519" \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
              "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" \
              "journalctl -u verzek-api.service -n 200"
            exit 1
          fi

          echo "‚úÖ Service is ACTIVE"

      - name: üß™ Test API endpoint
        run: |
          sleep 3
          
          # Capture both HTTP status and response body
          ssh -i "$HOME/.ssh/id_ed25519" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" << 'ENDSSH'
          set -o pipefail
          
          # Test health endpoint with verbose output
          HTTP_CODE=$(curl -sS -w '%{http_code}' -o /tmp/health_response.txt --max-time 10 http://localhost:8050/api/health || echo "000")
          RESPONSE=$(cat /tmp/health_response.txt 2>/dev/null || echo "No response")
          
          echo "üîç HTTP Status: $HTTP_CODE"
          echo "üìÑ Response Body: $RESPONSE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API test failed! HTTP $HTTP_CODE"
            echo "üìã Last 50 lines of service logs:"
            journalctl -u verzek-api.service -n 50 --no-pager
            exit 1
          fi
          
          if echo "$RESPONSE" | grep -qE '"ok":\s*true'; then
            echo "‚úÖ API Health Check PASSED"
            
            # Get version from /api/ping
            PING_RESPONSE=$(curl -sS --max-time 5 http://localhost:8050/api/ping || echo "{}")
            VERSION=$(echo "$PING_RESPONSE" | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
            echo "‚úÖ Backend Version: $VERSION"
          else
            echo "‚ùå Health check response invalid (missing 'ok':true)"
            echo "üìã Last 50 lines of service logs:"
            journalctl -u verzek-api.service -n 50 --no-pager
            exit 1
          fi
          ENDSSH

      - name: üìä Deployment summary
        if: success()
        run: |
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "URL: https://api.verzekinnovative.com"
          echo "Deployed at: $(date -u)"
          echo "Commit: ${{ github.sha }}"