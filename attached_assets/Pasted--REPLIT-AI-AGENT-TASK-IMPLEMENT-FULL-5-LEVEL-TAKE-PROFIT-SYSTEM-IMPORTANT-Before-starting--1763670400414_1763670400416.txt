
üü¶ REPLIT AI AGENT TASK ‚Äî IMPLEMENT FULL 5-LEVEL TAKE PROFIT SYSTEM

> IMPORTANT:
Before starting, ensure Fusion Engine tasks are already completed or in progress.




---

üìç PHASE 1 ‚Äî Update Signal Model to Support Multi-TP

Modify SignalCandidate (in signal_engine/core/models.py)

Ensure it includes:


take_profits: List[float]   # 5 TP levels

Modify SignalOutcome

Add:

current_tp_index: int       # last TP hit
total_tps: int              # always 5
partial_profits: List[float]  # store profit per TP hit


---

üìç PHASE 2 ‚Äî Implement NEW Multi-TP Logic in tracker.py

File: signal_engine/services/tracker.py

Add new DB columns:

current_tp_index INTEGER DEFAULT 0,
total_tps INTEGER DEFAULT 5,
partial_profits TEXT DEFAULT "[]"

Add a NEW method:

def on_target_hit(signal_id: str, hit_price: float):
    # Load signal from DB
    # Calculate profit % for this target
    # Append to partial_profits
    # Increment current_tp_index
    # If current_tp_index < total_tps:
    #     - DO NOT close the signal
    #     - Return partial TP outcome (for Telegram message)
    # Else:
    #     - Close signal (final TP)
    #     - Return final outcome (for TP5 message)

Update open_signal():

Set current_tp_index = 0

Set total_tps = len(take_profits) (always 5)

Set partial_profits = []



---

üìç PHASE 3 ‚Äî Backend Price Engine Integration

Wherever TP events are triggered (in backend service):

Replace old TP logic with:

outcome = tracker.on_target_hit(signal_id, current_price)
if outcome.is_final:
    telegram.send_final_tp_message(outcome)
else:
    telegram.send_partial_tp_message(outcome)


---

üìç PHASE 4 ‚Äî Update Dispatcher Messaging

File: signal_engine/services/dispatcher.py

Add 2 new message functions:

async def send_partial_tp_message(outcome: SignalOutcome):

async def send_final_tp_message(outcome: SignalOutcome):

Partial TP message format:

üî• VERZEK TRADING SIGNALS üî•

{symbol} - üö® Target {outcome.current_tp_index} reached
üí∏ Profit collected {outcome.profit_pct:.2f}%
‚è∞ Posted: {duration_string}

Final TP message format:

üî• VERZEK TRADING SIGNALS üî•

üèãüèª‚Äç‚ôÄÔ∏è Gained Profit on {symbol}
All take-profit targets achieved üòé
Profit: {outcome.profit_pct:.2f}% üìà
Period: {duration_string} ‚è∞


---

üìç PHASE 5 ‚Äî Dynamic TP5 (Final Take-Profit)

Modify bot signal generator (all bots) to generate exactly 5 TPs:

Fixed structure:

TP1 = entry ¬± (ATR * 0.5)
TP2 = entry ¬± (ATR * 1.0)
TP3 = entry ¬± (ATR * 1.5)
TP4 = entry ¬± (ATR * 2.0)
TP5 = entry ¬± (ATR * dynamic_multiplier)

Dynamic multiplier:

If trend strong ‚Üí 2.8  
If normal ‚Üí 2.3  
If weak ‚Üí 1.8  
If sideways ‚Üí 1.3

Where ‚Äútrend strength‚Äù = combination of:

MA distance

MACD slope

Volume trend

Volatility


Add this logic to:

scalping_bot.py

trend_bot.py

ai_bot.py

qfl_bot.py


(Wherever TP levels are generated.)


---

üìç PHASE 6 ‚Äî Ensure Fusion Engine Handles Multi-TP Signals

No change to Fusion logic EXCEPT:

When filtering candidate signals, always expect 5 TPs

Ensure approved signals still pass full TP list to dispatcher



---

üìç PHASE 7 ‚Äî Modify SQLite Query for Daily Reports

Update daily_reporter.py

Daily report must include:

Total signals

TP1 hits (partial TP count)

TP2 hits

TP3 hits

TP4 hits

TP5 hits (final TP closures)

SL count

Cancelled count

Winrate

Best trade

Worst trade

Avg duration

Avg profit


Example:

TP1 hits: 23
TP2 hits: 18
TP3 hits: 12
TP4 hits: 7
TP5 hits: 5 (Final + Closed)


---

üìç PHASE 8 ‚Äî Telegram ‚ÄúPosted X Hours Ago‚Äù

For EACH TP stage:

duration = outcome.closed_at - outcome.opened_at
Convert to ‚ÄúX Days Y Hours Z Minutes‚Äù

Use same format as your example screenshots.


---

üìç PHASE 9 ‚Äî AutoTrader Protection Logic

Add rules:

‚ùó DO NOT close trade early if TP1‚ÄìTP4 hit

(Only partial closure.)

‚ùó Close trade if:

SL hit

Opposite signal confirmed by Fusion Engine

Final TP5 hit


‚ùó Prevent double-counting of TP hits

Use current_tp_index to ensure each TP is counted once.


---

üìç PHASE 10 ‚Äî Final Integration Tests

After implementation, run:

ssh verzek_vultr "systemctl restart verzek-signalengine"
ssh verzek_vultr "tail -f /root/VerzekSignalEngine/signal_engine/logs/signal_engine.log"

Verify:

Signal opens with 5 TPs

TP1 message appears

TP2 message appears

‚Ä¶

TP5 final closure appears

No duplicate messages

Auto-trader respects OPEN ‚Üí PARTIAL ‚Üí FINAL


