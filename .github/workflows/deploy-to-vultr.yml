name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-to-vultr.yml'
      - 'reset_deploy.sh'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Display deployment info
        run: |
          echo "ðŸš€ Deploying VerzekAutoTrader Backend to Vultr"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"

      - name: ðŸ”‘ Prepare SSH key from base64
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VULTR_SSH_KEY_B64 }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 80.240.29.142 >> ~/.ssh/known_hosts

      - name: ðŸ§ª Test SSH connection
        run: |
          ssh -i ~/.ssh/id_rsa root@80.240.29.142 "echo 'SSH OK'" || exit 1

      - name: ðŸš€ Execute deployment script
        run: |
          ssh -i ~/.ssh/id_rsa root@80.240.29.142 << 'ENDSSH'
          cd /root/VerzekBackend
          git pull origin main
          bash /root/reset_deploy.sh
          ENDSSH

      - name: ðŸ” Verify service status
        run: |
          STATUS=$(ssh -i ~/.ssh/id_rsa root@80.240.29.142 "systemctl is-active verzek-api.service")
          if [ "$STATUS" != "active" ]; then
            echo "âŒ Service is DOWN"
            ssh -i ~/.ssh/id_rsa root@80.240.29.142 "journalctl -u verzek-api.service -n 50"
            exit 1
          fi
          echo "âœ… Service is ACTIVE"

      - name: ðŸ§ª Test API endpoint
        run: |
          sleep 3
          RESPONSE=$(ssh -i ~/.ssh/id_rsa root@80.240.29.142 "curl -s http://localhost:8050/api/ping")
          echo "API Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            VERSION=$(echo "$RESPONSE" | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… API responding - Version: $VERSION"
          else
            echo "âŒ API test failed"
            exit 1
          fi

      - name: ðŸ“Š Deployment summary
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "Production URL: https://api.verzekinnovative.com"
          echo "Deployed at: $(date -u)"
          echo "Commit: ${{ github.sha }}"
