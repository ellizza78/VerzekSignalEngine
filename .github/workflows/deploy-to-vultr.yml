name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'

      - '.github/workflows/deploy-to-vultr.yml'
      - 'reset_deploy.sh'
  workflow_dispatch:

jobs:
  deploy:
    # Only run deploy when at least one of the SSH secrets exists
    if: ${{ secrets.VULTR_SSH_KEY_B64 != '' || secrets.VULTR_SSH_PRIVATE_KEY != '' }}
    runs-on: ubuntu-latest
    env:
      VULTR_HOST: 80.240.29.142
      VULTR_USER: root
      REMOTE_DIR: /root/VerzekBackend

    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Display deployment info
        run: |
          echo "ðŸš€ Deploying VerzekAutoTrader Backend to Vultr"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"

      - name: ðŸ”§ Prepare SSH directory
        run: |
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh" || true

      - name: ðŸ”‘ Restore SSH private key (base64 or raw)
        env:
          VULTR_SSH_KEY_B64: ${{ secrets.VULTR_SSH_KEY_B64 }}
          VULTR_SSH_PRIVATE_KEY: ${{ secrets.VULTR_SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          SSH_KEY_PATH="$HOME/.ssh/id_rsa"
          mkdir -p "$(dirname "$SSH_KEY_PATH")"
          chmod 700 "$(dirname "$SSH_KEY_PATH")" || true

          if [ -n "${VULTR_SSH_KEY_B64:-}" ]; then
            echo "Using VULTR_SSH_KEY_B64"
            # Decode base64 safely; ignore whitespace issues
            printf '%s' "$VULTR_SSH_KEY_B64" | base64 --decode > "$SSH_KEY_PATH"
          elif [ -n "${VULTR_SSH_PRIVATE_KEY:-}" ]; then
            echo "Using VULTR_SSH_PRIVATE_KEY"
            printf '%s\n' "$VULTR_SSH_PRIVATE_KEY" > "$SSH_KEY_PATH"
          else
            echo "ERROR: No SSH private key provided. Set the secret VULTR_SSH_KEY_B64 (preferred) or VULTR_SSH_PRIVATE_KEY." >&2
            exit 1
          fi

          chmod 600 "$SSH_KEY_PATH"

          # Quick validity check of the private key
          if ! ssh-keygen -lf "$SSH_KEY_PATH" >/dev/null 2>&1; then
            echo "ERROR: The SSH private key is invalid or cannot be parsed by ssh-keygen." >&2
            exit 1
          fi

      - name: ðŸ—ï¸ Add host to known_hosts
        run: |
          ssh-keyscan -H "${{ env.VULTR_HOST }}" > "$HOME/.ssh/known_hosts" || true
          chmod 644 "$HOME/.ssh/known_hosts" || true

      - name: ðŸ§ª Test SSH connection
        run: |
          set -o pipefail
          ssh -i "$HOME/.ssh/id_rsa" -o BatchMode=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts -o ConnectTimeout=10 "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "echo 'SSH OK'" || (
            echo "SSH connection failed. Running verbose diagnostic..." >&2
            ssh -vvv -i "$HOME/.ssh/id_rsa" -o BatchMode=yes -o ConnectTimeout=10 "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" || true
            exit 1
          )

      - name: ðŸš€ Execute deployment on server
        run: |
          ssh -i "$HOME/.ssh/id_rsa" -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" << 'ENDSSH'
          set -euo pipefail

          # Ensure repo directory exists and is on the correct branch
          if [ ! -d "/root/VerzekBackend" ]; then
            echo "Remote directory not found. Cloning repository..."
            git clone https://github.com/ellizza78/VerzekBackend.git /root/VerzekBackend
          fi

          cd /root/VerzekBackend
          git fetch origin main
          git reset --hard origin/main

          # Ensure reset_deploy.sh is executable; try local copy if missing in /root
          if [ -x /root/reset_deploy.sh ]; then
            bash /root/reset_deploy.sh
          elif [ -x ./reset_deploy.sh ]; then
            bash ./reset_deploy.sh
          else
            echo "Warning: reset_deploy.sh not found or not executable. Skipping script execution."
          fi
          ENDSSH

      - name: ðŸ” Verify service status
        run: |
          STATUS=$(ssh -i "$HOME/.ssh/id_rsa" -o BatchMode=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "systemctl is-active verzek-api.service || true")
          if [ "$STATUS" != "active" ]; then
            echo "âŒ Service is DOWN (status=$STATUS)"
            ssh -i "$HOME/.ssh/id_rsa" -o BatchMode=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "journalctl -u verzek-api.service -n 200 || true"
            exit 1
          fi
          echo "âœ… Service is ACTIVE"

      - name: ðŸ§ª Test API endpoint
        run: |
          sleep 3
          RESPONSE=$(ssh -i "$HOME/.ssh/id_rsa" -o BatchMode=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "curl -sS --max-time 5 http://localhost:8080/health || true")
          echo "API Response: $RESPONSE"
          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            VERSION=$(echo "$RESPONSE" | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || true)
            echo "âœ… API responding - Version: $VERSION"
          else
            echo "âŒ API test failed; dumping recent container logs and journal output"
            ssh -i "$HOME/.ssh/id_rsa" -o BatchMode=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$HOME/.ssh/known_hosts "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "journalctl -u verzek-api.service -n 200 || true"
            exit 1
          fi

      - name: ðŸ“Š Deployment summary
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "Production URL: https://api.verzekinnovative.com"
          echo "Deployed at: $(date -u)"
          echo "Commit: ${{ github.sha }}"
