name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-to-vultr.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Checkout code (no submodules)
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: ðŸ“‹ Display deployment info
        run: |
          echo "ðŸš€ Deploying VerzekAutoTrader Backend to Vultr"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"

      #######################################
      # ðŸ”‘ PREPARE BASE64 SSH KEY
      #######################################
      - name: ðŸ”‘ Prepare SSH key from base64
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VULTR_SSH_KEY_B64 }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 80.240.29.142 >> ~/.ssh/known_hosts

      #######################################
      # ðŸ§ª TEST SSH CONNECTION
      #######################################
      - name: ðŸ§ª Test SSH connection (verbose)
        run: |
          ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -vvv root@80.240.29.142 "echo 'âœ… SSH connection successful'" || true

      #######################################
      # ðŸš€ DEPLOY
      #######################################
      - name: ðŸš€ Execute deployment script
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no root@80.240.29.142 << 'ENDSSH'
          cd /root
          echo "ðŸ“¥ Running deployment script..."
          bash /root/reset_deploy.sh
          echo "â³ Waiting for services to stabilize..."
          sleep 5
          echo "âœ… Deployment complete!"
          ENDSSH

      #######################################
      # ðŸ” VERIFY SERVICE
      #######################################
      - name: ðŸ” Verify service status
        run: |
          SERVICE_STATUS=$(ssh -i ~/.ssh/id_rsa -o BatchMode=yes root@80.240.29.142 "systemctl is-active verzek-api.service" || echo "unknown")
          if [ "$SERVICE_STATUS" = "active" ]; then
            echo "âœ… verzek-api.service is ACTIVE"
          else
            echo "âŒ verzek-api.service is NOT active! (status: $SERVICE_STATUS)"
            ssh -i ~/.ssh/id_rsa root@80.240.29.142 "journalctl -u verzek-api.service -n 50" || true
            exit 1
          fi

      #######################################
      # ðŸ§ª VALIDATION
      #######################################
      - name: ðŸ§ª Run validation suite (STRICT mode)
        run: |
          chmod +x validate_deployment.sh
          ./validate_deployment.sh --strict

      #######################################
      # SUMMARY
      #######################################
      - name: ðŸ“Š Deployment summary
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          BACKEND_VERSION=$(grep -E "^Version:" backend/api_version.txt | sed 's/Version: //')
          echo "ðŸ“¦ Backend Version: ${BACKEND_VERSION}"
          echo "ðŸŒ Production URL: https://api.verzekinnovative.com"
          echo "ðŸ“… Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸ“ Commit: ${{ github.sha }}"

      - name: ðŸ†˜ Deployment failure notice
        if: failure()
        run: |
          echo "âŒ DEPLOYMENT FAILED!"
          echo "Check the logs above for error details"
          echo "To rollback: ssh root@80.240.29.142; systemctl status verzek-api.service; journalctl -u verzek-api.service -n 50"
