name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-to-vultr.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“‹ Display deployment info
        run: |
          echo "ðŸš€ Deploying VerzekAutoTrader Backend to Vultr"
          echo "================================================"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          
      - name: ðŸ”§ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VULTR_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VULTR_HOST }} >> ~/.ssh/known_hosts
          
      - name: ðŸ§ª Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VULTR_HOST }} "echo 'âœ… SSH connection successful'"
          
      - name: ðŸš€ Execute deployment script
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VULTR_HOST }} << 'ENDSSH'
          cd /root
          echo "ðŸ“¥ Running deployment script..."
          bash /root/reset_deploy.sh
          
          echo ""
          echo "â³ Waiting for services to stabilize..."
          sleep 5
          
          echo "âœ… Deployment complete!"
          ENDSSH
          
      - name: ðŸ” Verify service status
        run: |
          SERVICE_STATUS=$(ssh root@${{ secrets.VULTR_HOST }} "systemctl is-active verzek-api.service")
          if [ "$SERVICE_STATUS" = "active" ]; then
            echo "âœ… verzek-api.service is ACTIVE"
          else
            echo "âŒ verzek-api.service is NOT active!"
            exit 1
          fi
          
      - name: ðŸ§ª Test API endpoints
        run: |
          echo "Testing /api/ping..."
          PING_RESPONSE=$(curl -s -w "\n%{http_code}" https://api.verzekinnovative.com/api/ping | tail -1)
          if [ "$PING_RESPONSE" = "200" ]; then
            echo "âœ… /api/ping responding (200 OK)"
            curl -s https://api.verzekinnovative.com/api/ping
          else
            echo "âŒ /api/ping failed (HTTP $PING_RESPONSE)"
            exit 1
          fi
          
          echo ""
          echo "Testing /api/health..."
          HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" https://api.verzekinnovative.com/api/health | tail -1)
          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… /api/health responding (200 OK)"
            curl -s https://api.verzekinnovative.com/api/health
          else
            echo "âŒ /api/health failed (HTTP $HEALTH_RESPONSE)"
            exit 1
          fi
          
      - name: ðŸ“Š Deployment summary
        if: success()
        run: |
          echo "================================================"
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "================================================"
          echo ""
          echo "ðŸ“¦ Backend Version: 2.1"
          echo "ðŸŒ Production URL: https://api.verzekinnovative.com"
          echo "ðŸ“… Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo ""
          
      - name: ðŸ†˜ Deployment failure notice
        if: failure()
        run: |
          echo "================================================"
          echo "âŒ DEPLOYMENT FAILED!"
          echo "================================================"
          echo ""
          echo "Check the logs above for error details"
          echo "To rollback:"
          echo "  ssh root@${{ secrets.VULTR_HOST }}"
          echo "  systemctl status verzek-api.service"
          echo "  journalctl -u verzek-api.service -n 50"
          echo ""
