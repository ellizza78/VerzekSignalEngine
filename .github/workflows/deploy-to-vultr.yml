name: Deploy Backend to Vultr

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'reset_deploy.sh'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VULTR_HOST: 80.240.29.142
      VULTR_USER: root
      REMOTE_DIR: /root/VerzekBackend

    steps:
      - name: ðŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Display deployment info
        run: |
          echo "ðŸš€ Deploying VerzekAutoTrader Backend to Vultr"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"

      - name: ðŸ”§ Prepare SSH directory
        run: |
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

      - name: ðŸ”‘ Restore SSH private key
        env:
          VULTR_SSH_KEY: ${{ secrets.VULTR_SSH_KEY }}
        run: |
          set -euo pipefail

          if [ -z "${VULTR_SSH_KEY:-}" ]; then
            echo "âŒ ERROR: No SSH private key provided. Set secret VULTR_SSH_KEY."
            exit 1
          fi

          SSH_KEY_PATH="$HOME/.ssh/id_rsa"
          printf '%s\n' "$VULTR_SSH_KEY" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"

          if ! ssh-keygen -lf "$SSH_KEY_PATH" >/dev/null 2>&1; then
            echo "âŒ ERROR: SSH key is invalid"
            exit 1
          fi

      - name: ðŸ—ï¸ Add host to known_hosts
        run: |
          ssh-keyscan -H "${{ env.VULTR_HOST }}" > "$HOME/.ssh/known_hosts"
          chmod 644 "$HOME/.ssh/known_hosts"

      - name: ðŸ§ª Test SSH connection
        run: |
          set -o pipefail
          ssh -i "$HOME/.ssh/id_rsa" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            -o ConnectTimeout=10 \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" "echo SSH OK" \
          || (
            echo "SSH FAILED â€” running verbose diagnostics..."
            ssh -vvv -i "$HOME/.ssh/id_rsa" \
              "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" || true
            exit 1
          )

      - name: ðŸš€ Execute deployment on server
        run: |
          ssh -i "$HOME/.ssh/id_rsa" \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" << 'ENDSSH'
          set -euo pipefail

          # Clone repo if missing
          if [ ! -d "/root/VerzekBackend" ]; then
            echo "Repo directory missing â€” cloning fresh using SSH"
            git clone git@github.com:ellizza78/VerzekBackend.git /root/VerzekBackend
          fi

          cd /root/VerzekBackend

          echo "Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          # Run reset script if available
          if [ -x /root/reset_deploy.sh ]; then
            bash /root/reset_deploy.sh
          elif [ -x ./reset_deploy.sh ]; then
            bash ./reset_deploy.sh
          else
            echo "âš ï¸ reset_deploy.sh not found â€” skipping"
          fi
          ENDSSH

      - name: ðŸ” Verify service status
        run: |
          STATUS=$(ssh -i "$HOME/.ssh/id_rsa" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" \
            "systemctl is-active verzek-api.service || true")

          if [ "$STATUS" != "active" ]; then
            echo "âŒ Service is DOWN ($STATUS)"
            ssh -i "$HOME/.ssh/id_rsa" \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
              "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" \
              "journalctl -u verzek-api.service -n 200"
            exit 1
          fi

          echo "âœ… Service is ACTIVE"

      - name: ðŸ§ª Test API endpoint
        run: |
          sleep 3
          RESPONSE=$(ssh -i "$HOME/.ssh/id_rsa" \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
            "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" \
            "curl -sS --max-time 5 http://localhost:8080/health || true")

          echo "API Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"status":"ok"'; then
            VERSION=$(echo "$RESPONSE" | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… API OK â€” Version: $VERSION"
          else
            echo "âŒ API FAILED â€” dumping logs"
            ssh -i "$HOME/.ssh/id_rsa" \
              -o BatchMode=yes \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=$HOME/.ssh/known_hosts \
              "${{ env.VULTR_USER }}@${{ env.VULTR_HOST }}" \
              "journalctl -u verzek-api.service -n 200"
            exit 1
          fi

      - name: ðŸ“Š Deployment summary
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "URL: https://api.verzekinnovative.com"
          echo "Deployed at: $(date -u)"
          echo "Commit: ${{ github.sha }}"
